/************************************************************
 * CONFIG
 ************************************************************/
const SS_ID = "1KQ4uKabzjyVcw6a-wlqHFha7OWPfgqbghFXS59dZf5Q";


/************************************************************
 * CORS WRAPPER (UNTUK GITHUB PAGES)
 ************************************************************/
function withCors(output) {
  return output
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type");
}


/************************************************************
 * ENTRY POINT — GET
 ************************************************************/
function doGet(e) {
  const result = handleGet(e);
  return withCors(result);
}


/************************************************************
 * ENTRY POINT — POST
 ************************************************************/
function doPost(e) {
  const result = handlePost(e);
  return withCors(result);
}


/************************************************************
 * GET ROUTER
 ************************************************************/
function handleGet(e) {
  try {
    if (e && e.parameter) {

      if (e.parameter.action === "getitem") {
        return getItemList();
      }

      if (e.parameter.action === "getkpc") {
        return getKPCList();
      }
    }

    return ContentService.createTextOutput("Production Web App Active");

  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({ status: "error", message: err }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}


/************************************************************
 * POST HANDLER — SAVE PRODUCTION
 ************************************************************/
function handlePost(e) {
  try {
    const data = JSON.parse(e.postData.contents);

    const ss = SpreadsheetApp.openById(SS_ID);

    const sheetProses = ss.getSheetByName("Proses Produksi");
    const sheetWE = ss.getSheetByName("WE - Production FG");

    const timestamp = new Date();
    const productionDate = data.productionDate;
    const notes = data.notes || "";
    const items = data.items;

    if (!items || items.length === 0) throw "No items received.";

    // Append to both sheets
    items.forEach(row => {
      const newRow = [
        timestamp,        // A
        row.item,         // B
        productionDate,   // C
        row.meter,        // D
        row.qty,          // E
        row.total,        // F
        row.kpc,          // G
        notes             // H
      ];

      sheetProses.appendRow(newRow);
      sheetWE.appendRow(newRow);
    });

    return ContentService
      .createTextOutput(JSON.stringify({ status: "success" }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({ status: "error", message: err }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}


/************************************************************
 * GET — Item List (Column A)
 ************************************************************/
function getItemList() {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("List Item FG");

  const data = sheet.getRange("A2:A").getValues()
    .flat()
    .filter(v => v && String(v).trim() !== "");

  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}


/************************************************************
 * GET — KPC List (Column A)
 ************************************************************/
function getKPCList() {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sheet = ss.getSheetByName("List KPC");

  const data = sheet.getRange("A2:A").getValues()
    .flat()
    .filter(v => v && String(v).trim() !== "");

  data.push("Others");

  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
